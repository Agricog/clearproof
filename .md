# ClearProof - Technical Documentation

## Overview

**Product:** Multilingual Health & Safety Comprehension Verification System  
**Domain:** clearproof.co.uk (frontend) / api.clearproof.co.uk (backend)  
**Purpose:** Sites upload safety content → AI transforms/translates → Workers verify understanding → Full audit trail for HSE compliance

---

## Tech Stack

| Layer | Technology |
|-------|------------|
| Frontend | React 18 + TypeScript + Vite + Tailwind CSS |
| Backend | Node.js + Express + TypeScript |
| Database | SmartSuite |
| AI | Anthropic Claude API (claude-sonnet-4-20250514) |
| Authentication | Clerk |
| Hosting | Railway (separate services for frontend/backend) |

---

## Architecture

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│                 │     │                 │     │                 │
│   Frontend      │────▶│   Backend API   │────▶│   SmartSuite    │
│   (React)       │     │   (Express)     │     │   (Database)    │
│                 │     │                 │     │                 │
└─────────────────┘     └────────┬────────┘     └─────────────────┘
                                 │
                                 ▼
                        ┌─────────────────┐
                        │                 │
                        │   Claude API    │
                        │   (Anthropic)   │
                        │                 │
                        └─────────────────┘
```

---

## Features Implemented

### Core Features

| Feature | Description | Status |
|---------|-------------|--------|
| PDF/TXT Upload | Parse and extract text from uploaded documents | ✅ |
| AI Content Transformation | Simplify H&S content for worker comprehension | ✅ |
| Multilingual Translation | Support for 10+ languages | ✅ |
| Comprehension Questions | AI-generated scenario-based questions | ✅ |
| Worker Verification Flow | Multi-step verification process | ✅ |
| QR Code Generation | Downloadable QR codes for each module | ✅ |
| Dashboard Stats | Live counts of modules, workers, verifications | ✅ |
| Reports & Export | Filter by date range, CSV export | ✅ |
| Module Management | Create, update, delete modules | ✅ |
| Audit Logging | Full trail of all actions | ✅ |

### Supported Languages

| Language | Code | Verification ID | Worker ID |
|----------|------|-----------------|-----------|
| English | en | 6aUDS | XC10L |
| Polski | pl | Muktb | Tiq7v |
| Română | ro | yRVjF | w1bw5 |
| Português | pt | r2HZE | 15JFJ |
| Español | es | sDjl2 | qTtdO |
| Українська | uk | xD6t8 | BXLR5 |
| Lietuvių | lt | ci01V | skKFJ |
| Български | bg | uMhn2 | 4w74b |
| Magyar | hu | QBwLR | 1Qcep |
| हिन्दी | hi | C8izU | ibj9p |

---

## Security Implementation

### Authentication & Authorization

| Feature | Implementation | Details |
|---------|----------------|---------|
| Authentication | Clerk | JWT-based, MFA available |
| Token Storage | Clerk-managed | Secure, automatic rotation |
| Session Handling | Clerk-managed | Secure session management |
| Protected Routes | requireAuth() middleware | Server-side enforcement |

### Security Headers (Helmet.js)

```javascript
helmet({
  contentSecurityPolicy: {
    directives: {
      defaultSrc: ["'self'"],
      styleSrc: ["'self'", "'unsafe-inline'"],
      scriptSrc: ["'self'"],
      imgSrc: ["'self'", "data:", "https:"],
      connectSrc: ["'self'", ...allowedOrigins],
      fontSrc: ["'self'", "https:", "data:"],
      objectSrc: ["'none'"],
      mediaSrc: ["'self'"],
      frameSrc: ["'none'"]
    }
  },
  crossOriginEmbedderPolicy: false,
  crossOriginResourcePolicy: { policy: "cross-origin" }
})
```

**Headers Applied:**
- X-Content-Type-Options: nosniff
- X-Frame-Options: DENY
- X-XSS-Protection
- Strict-Transport-Security
- Content-Security-Policy
- Cross-Origin policies

### Rate Limiting

| Limiter | Window | Max Requests | Purpose |
|---------|--------|--------------|---------|
| generalLimiter | 15 min | 100 | General API protection |
| authLimiter | 15 min | 20 | Auth endpoint protection |
| processLimiter | 60 min | 30 | AI processing protection |
| verificationLimiter | 15 min | 10 per IP+module | Verification abuse prevention |
| uploadLimiter | 60 min | 20 | Upload abuse prevention |

### Bot Protection

| Method | Implementation |
|--------|----------------|
| Honeypot Fields | Hidden `website` and `company_url` fields |
| Timing Check | Submissions under 10 seconds rejected |
| Rate Limiting | Per IP + module combination |

### CORS Configuration

```javascript
const allowedOrigins = [
  'http://localhost:5173',
  'https://clearproof.co.uk',
  'https://www.clearproof.co.uk'
]
```

### Data Protection

| Aspect | Implementation |
|--------|----------------|
| Encryption in Transit | TLS via Railway |
| Encryption at Rest | SmartSuite/Railway managed |
| Input Validation | Zod schemas on all endpoints |
| CSRF Protection | Bearer tokens (not cookies) |

### Dependency Scanning

GitHub Dependabot configured for both repositories:

```yaml
version: 2
updates:
  - package-ecosystem: "npm"
    directory: "/"
    schedule:
      interval: "weekly"
    open-pull-requests-limit: 10
```

---

## SmartSuite Database Schema

### Workspace ID
`sba974gi`

### Tables

#### Modules Table
**Table ID:** `69441e0e081da2e01f4d9a78`

| Field | ID | Type |
|-------|-----|------|
| Title | `title` | Text |
| Original Content | `sbd46df988` | Text (120k char limit) |
| Processed Content | `sde7e5250a` | Text |
| Questions | `sceb501715` | Text (JSON) |
| Status | `status` | Object: `{value: string, updated_on: null}` |
| Created On | `sc8d4acbb6` | Object: `{date: string, include_time: boolean}` |
| QR Code | `s4ad3aec2f` | Text (URL) |

#### Workers Table
**Table ID:** `69441f0deb5683351ec55a8f`

| Field | ID | Type |
|-------|-----|------|
| Title | `title` | Text |
| Full Name | `s7e2a81290` | Object: `{title, first_name, middle_name, last_name, sys_root}` |
| Worker ID | `s2770480d5` | Text |
| Phone | `sb41d35a00` | Array: `[{phone_number, phone_country}]` |
| Preferred Language | `s9e17bccf0` | Dropdown (language IDs) |
| Created On | `s3cb92d18f` | Object: `{date: string, include_time: boolean}` |

#### Verifications Table
**Table ID:** `69441fd3d9350cee4e1b8e3e`

| Field | ID | Type |
|-------|-----|------|
| Title | `title` | Text |
| Module | `s31291a1f8` | Linked record (array) |
| Worker | `s124b3759e` | Linked record (array) |
| Language Used | `sdf057bfc7` | Dropdown (language IDs) |
| Answers | `sb8efe66b2` | Text (JSON) |
| Score | `s3c84ba4fe` | Number |
| Passed | `se4e7a05e3` | Checklist |
| Completed At | `s8664c0809` | Object: `{date: string, include_time: boolean}` |
| IP Address | `scaaea2ee3` | Text |

#### Audit Logs Table
**Table ID:** `694440eb0dc34459d50511cd`

| Field | ID | Type |
|-------|-----|------|
| Title | `title` | Text |
| User ID | `sd4400df5f` | Text |
| Action | `s2fbf046cb` | Text |
| Resource | `se5c4b6aa6` | Text |
| Resource ID | `sf3515c7f5` | Text |
| IP Address | `s7d26da42e` | Text |
| Details | `s0b9cb63d0` | Text (JSON) |
| Timestamp | `due_date` | Built-in field |

---

## API Endpoints

### Modules

| Method | Endpoint | Auth | Description |
|--------|----------|------|-------------|
| GET | `/api/modules` | Yes | List all modules |
| GET | `/api/modules/:id` | No | Get single module |
| POST | `/api/modules` | Yes | Create module |
| PATCH | `/api/modules/:id` | Yes | Update module |
| DELETE | `/api/modules/:id` | Yes | Delete module |
| POST | `/api/modules/upload` | Yes | Upload PDF/TXT file |
| GET | `/api/modules/:id/qr` | No | Download QR code PNG |

### Workers

| Method | Endpoint | Auth | Description |
|--------|----------|------|-------------|
| GET | `/api/workers` | Yes | List all workers |
| GET | `/api/workers/:id` | Yes | Get single worker |
| POST | `/api/workers` | Yes | Create worker |
| PATCH | `/api/workers/:id` | Yes | Update worker |

### Verifications

| Method | Endpoint | Auth | Description |
|--------|----------|------|-------------|
| GET | `/api/verifications` | Yes | List all verifications |
| GET | `/api/verifications/:id` | Yes | Get single verification |
| POST | `/api/verifications` | No | Create verification (rate limited) |

### Processing

| Method | Endpoint | Auth | Description |
|--------|----------|------|-------------|
| POST | `/api/process/transform/:moduleId` | Yes | Transform content + generate questions |
| POST | `/api/process/translate` | No | Translate content |
| POST | `/api/process/questions` | No | Generate questions |

---

## Frontend Routes

| Route | Component | Auth | Description |
|-------|-----------|------|-------------|
| `/` | Landing | No | Marketing landing page |
| `/login` | Login | No | Clerk authentication |
| `/privacy` | Privacy | No | Privacy policy |
| `/terms` | Terms | No | Terms of service |
| `/dashboard` | Dashboard | Yes | Stats overview |
| `/dashboard/upload` | Upload | Yes | Upload new module |
| `/dashboard/modules` | Modules | Yes | Module management |
| `/dashboard/reports` | Reports | Yes | Compliance reports |
| `/verify/:moduleId` | Verify | No | Worker verification flow |

---

## File Structure

### Backend (`clearproof-api`)

```
clearproof-api/
├── .github/
│   └── dependabot.yml
├── src/
│   ├── middleware/
│   │   ├── auth.ts
│   │   ├── rateLimit.ts
│   │   └── validate.ts
│   ├── routes/
│   │   ├── modules.ts
│   │   ├── workers.ts
│   │   ├── verifications.ts
│   │   └── process.ts
│   ├── services/
│   │   ├── smartsuite.ts
│   │   ├── claude.ts
│   │   └── audit.ts
│   ├── schemas/
│   │   └── index.ts
│   ├── types/
│   │   ├── pdf-parse.d.ts
│   │   └── qrcode.d.ts
│   └── index.ts
├── package.json
└── tsconfig.json
```

### Frontend (`clearproof`)

```
clearproof/
├── .github/
│   └── dependabot.yml
├── public/
│   ├── favicon.svg
│   └── og-image.png
├── src/
│   ├── components/
│   │   ├── layouts/
│   │   │   ├── ManagerLayout.tsx
│   │   │   └── WorkerLayout.tsx
│   │   └── AuthInit.tsx
│   ├── pages/
│   │   ├── manager/
│   │   │   ├── Dashboard.tsx
│   │   │   ├── Upload.tsx
│   │   │   ├── Modules.tsx
│   │   │   └── Reports.tsx
│   │   ├── worker/
│   │   │   └── Verify.tsx
│   │   ├── Landing.tsx
│   │   ├── Login.tsx
│   │   ├── Privacy.tsx
│   │   └── Terms.tsx
│   ├── services/
│   │   └── api.ts
│   ├── types/
│   │   └── clerk.d.ts
│   ├── App.tsx
│   ├── main.tsx
│   └── index.css
├── index.html
├── package.json
├── tailwind.config.js
├── tsconfig.json
└── vite.config.ts
```

---

## Environment Variables

### Frontend (Railway)

| Variable | Description |
|----------|-------------|
| `VITE_CLERK_PUBLISHABLE_KEY` | Clerk public key |
| `VITE_API_URL` | API base URL (optional, defaults to api.clearproof.co.uk) |

### Backend (Railway)

| Variable | Description |
|----------|-------------|
| `CLERK_PUBLISHABLE_KEY` | Clerk public key |
| `CLERK_SECRET_KEY` | Clerk secret key |
| `SMARTSUITE_API_KEY` | SmartSuite API key |
| `ANTHROPIC_API_KEY` | Claude API key |
| `PORT` | Server port (default: 3001) |

---

## SEO Implementation

### Meta Tags (index.html)

- Title tag with primary keyword
- Meta description with keywords
- Open Graph tags for social sharing
- Twitter Card tags
- Schema.org structured data (SoftwareApplication)
- Canonical URL
- Robots meta tag

### Landing Page

- Semantic HTML structure (header, main, footer, section, article, nav)
- H1 with primary keyword
- Proper heading hierarchy (H1 → H2 → H3)
- Internal linking
- Keyword-rich content
- Clear CTAs
- Mobile responsive

---

## Content Limits

| Limit | Value | Reason |
|-------|-------|--------|
| SmartSuite field | 120,000 chars | Platform limit |
| Upload truncation | 100,000 chars | Safety margin |
| Claude processing | 25,000 chars | Rate limit management |
| Claude rate limit | 30,000 tokens/min | API tier limit |

---

## Worker Verification Flow

1. **Language Selection** - Worker selects preferred language
2. **Details Entry** - Name and Worker ID/Badge number
3. **Content Reading** - Translated, simplified safety content
4. **Comprehension Test** - AI-generated scenario questions
5. **Result** - Pass (≥80%) or Fail with score displayed
6. **Audit Record** - Full verification logged with timestamp

---

## Dependencies

### Backend

```json
{
  "@clerk/express": "^1.0.2",
  "cors": "^2.8.5",
  "express": "^4.18.2",
  "express-rate-limit": "^7.1.5",
  "helmet": "^8.0.0",
  "multer": "^1.4.5-lts.1",
  "pdf-parse": "^1.1.1",
  "qrcode": "^1.5.4",
  "zod": "^3.22.4"
}
```

### Frontend

```json
{
  "@clerk/clerk-react": "^5.x",
  "lucide-react": "^0.x",
  "react": "^18.x",
  "react-dom": "^18.x",
  "react-router-dom": "^6.x"
}
```

---

## Future Enhancements

| Feature | Priority | Description |
|---------|----------|-------------|
| Pricing Page | High | Add pricing tiers |
| Stripe Integration | High | Payment processing |
| Email Notifications | Medium | Notify on verification completion |
| Multi-tenancy | Medium | Separate data per organization |
| Analytics | Low | Usage tracking and insights |
| Bulk QR Export | Low | Download all QR codes as ZIP |

---

## Deployment

Both services are deployed on Railway with automatic deployments from GitHub:

- **Frontend:** Builds with `npm run build`, serves static files
- **Backend:** Builds with `npm run build`, runs `npm start`

Custom domains configured:
- `clearproof.co.uk` → Frontend service
- `api.clearproof.co.uk` → Backend service

---

## Support

For technical support or questions:
- Email: hello@clearproof.co.uk

---

*Documentation generated: December 2024*
